# Copyright (c) Microsoft. All rights reserved.
# Licensed under the MIT license. See LICENSE file in the project root for full license information.

# GitHub repository operations for propagate_updates.ps1

# Source dependencies
. "$PSScriptRoot\status_tracking.ps1"
. "$PSScriptRoot\watch_github_pr.ps1"

# update dependencies for Github repo
# Returns the PR URL for status tracking
function update-repo-github
{
    param(
        [string] $repo_name,
        [string] $new_branch_name
    )
    $fn_result = $null

    Push-Location $repo_name
    Write-Host "`nCreating PR"
    $working_directory = (Get-Location).Path
    $null = gh pr create --title "[autogenerated] update dependencies" --body "Propagating dependency updates" --head $new_branch_name

    # Get PR URL
    $pr_info = gh pr view --json url 2>&1
    if($LASTEXITCODE -eq 0)
    {
        $pr_data = $pr_info | ConvertFrom-Json
        $fn_result = $pr_data.url
    }
    else
    {
        # couldn't get PR URL
    }

    # Update status with PR URL immediately so it shows even if later steps fail
    set-repo-status -repo_name $repo_name -status $script:STATUS_IN_PROGRESS -pr_url $fn_result

    # Small wait to ensure PR is fully created before triggering pipeline
    Start-Sleep -Seconds 5
    $null = gh pr comment --body "/AzurePipelines run"
    Write-Host "Waiting for checks to start"
    Start-Sleep -Seconds 120

    Write-Host "Waiting for build to complete"
    $watch_result = watch-github-pr-checks -poll_interval 30 -timeout 120 -OnIteration { [void](show-propagation-status) }
    if(-not $watch_result.Success)
    {
        fail-with-status "PR checks failed for repo ${repo_name}: $($watch_result.Message)"
    }
    else
    {
        Write-Host "PR checks passed" -ForegroundColor Green
    }

    Write-Host "Merging PR"
    $null = gh pr merge --squash --delete-branch
    if($LASTEXITCODE -ne 0)
    {
        fail-with-status "Failed to merge PR for repo $repo_name"
    }
    else
    {
        Write-Host "PR merged successfully" -ForegroundColor Green
    }
    # Wait for merge to complete
    Start-Sleep -Seconds 10
    Pop-Location

    return $fn_result
}
