name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true

jobs:
# Windows builds using build_all_flavors template
- template: /pipeline_templates/build_all_flavors.yml
  parameters:
    cmake_options: "-Drun_reals_check:bool=ON -Drun_unittests:bool=ON -Drun_int_tests:bool=ON -Drun_perf_tests:bool=ON -Duse_cppunittest:bool=ON -Drun_e2e_tests:BOOL=ON"
    repo_root_override: $(Build.SourcesDirectory)
    FSANITIZE_TYPE_VALUES: ["OFF"]
    # c-build-tools doesn't have VSTest-compatible tests, disable minimum test check
    failOnMinTestsNotRun: false

# srs_extension tests (run once, not per build configuration)
- job: srs_extension_tests
  displayName: 'srs_extension npm tests'
  pool:
    name: Azure-MessagingStore-WinBuildPoolVS2022_0
  steps:
  - task: Npm@1
    displayName: 'npm install for srs_extension'
    inputs:
      command: install
      workingDir: srs_extension

  - task: Npm@1
    displayName: 'npm run tests for srs_extension'
    inputs:
      command: custom
      customCommand: 'run test --verbose'
      workingDir: srs_extension

- template: /pipeline_templates/codeql3000_default.yml
  parameters:
    repo_root: $(Build.SourcesDirectory)

- job: linuxubuntu
  displayName: 'Build Linux Ubuntu 22.04'
  pool:
    name: Azure-MsgStore-Linux2204BuildMachinePool
    demands:
    - linux
  steps:
  - bash: |
     pushd $(Build.Repository.LocalPath)
     git submodule update --init
     git submodule foreach --recursive "git clean -xdff"
     git clean -xdff
     popd
    workingDirectory: '$(Build.Repository.LocalPath)'
    displayName: 'git submodule update and clean'

  - template: /pipeline_templates/run_with_crash_reports.yml
    parameters:
      build_directory: $(Build.Repository.LocalPath)/cmake_linux
      test_script: |
        ./build/linux/build_linux.sh $(Build.Repository.LocalPath)
      test_displayName: 'Build and run tests'
      test_workingDirectory: '$(Build.Repository.LocalPath)'
