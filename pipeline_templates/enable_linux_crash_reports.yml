# This template enables Linux core dump collection for crash debugging.
# Sets kernel.core_pattern to write core files directly to the crash reports directory.
# This is a system-level setting that persists across pipeline steps.
#
# IMPORTANT: The consuming pipeline must also run `ulimit -c unlimited` in the same
# shell/step that executes the tests. ulimit is per-process and does NOT persist
# across pipeline steps.
#
# Usage:
#   - template: pipeline_templates/enable_linux_crash_reports.yml@c_build_tools
#     parameters:
#       crash_reports_directory: $(Build.ArtifactStagingDirectory)/crash_reports

parameters:
  - name: crash_reports_directory
    default: $(Build.ArtifactStagingDirectory)/crash_reports

steps:
  - bash: |
      # Create crash reports output directory
      mkdir -p "${{ parameters.crash_reports_directory }}"
      echo "Crash reports directory created: ${{ parameters.crash_reports_directory }}"

      # Set kernel core pattern to write core files to the crash reports directory
      # Format: core.<executable_name>.<pid>.<timestamp>
      # Note: ulimit -c must be set in the same shell that runs tests
      sudo sysctl -w kernel.core_pattern="${{ parameters.crash_reports_directory }}/core.%e.%p.%t"
      echo "Core pattern set to: $(cat /proc/sys/kernel/core_pattern)"
    displayName: 'Enable Linux crash reports'
